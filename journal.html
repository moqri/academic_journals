<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Scholarly Journals Database</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel = "stylesheet" type = "text/css" href = "css/style.css">

	</head>
	<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">	
	<br></br>
	<h3>Impact</h3>
	<table class="table" id="data-table">
	    <thead>
	        <tr>
	            <th>Year</th>
	            <th>Citable Documents</th>
	            <th>Citations</th>
	            <th>Impact (Articles/Citations)</th>
	            <th>h-index</th>
	        </tr>	        
	    </thead>
	    <tbody>
	        <tr>
				<td>2014</td>
				<td id='2014_articles'></td>
				<td id='2014_citations'></td>
				<td id='2014_impact'></td>
				<td id='2014_h'></td>
	        </tr>
	        <tr>
				<td>2015</td>
				<td id='2015_articles'></td>
				<td id='2015_citations'></td>
				<td id='2015_impact'></td>
				<td id='2015_h'></td>
	        </tr>
	        <tr>
	        	<td>2016</td>
				<td id='2016_articles'></td>
				<td id='2016_citations'></td>
				<td id='2016_impact'></td>
				<td id='2016_h'></td>
	        </tr>
	        <tr>
	        	<td>3-year</td>
				<td id='citable_articles'></td>
				<td id='total_citations'></td>
				<td id='total_impact'></td>
				<td id='total_h'></td>
	        </tr>
	    </tbody>
	</table>
	<h3>h-indexed Articles</h3>
	<table class="table" id='top'>
		<thead>
			<th>Article</th>
			<th>Year</th>
			<th>Citations</th>
		</thead>
	</table>
	<div class="loader"></div>
	</div>
</body>
<script>
	function h_index(cites_3years){
		var h=0
		cites_3years.sort(function (a, b) {  return b - a;  });
    	for (i=1; i <= cites_3years.length; i++){
            if (cites_3years[i-1] >= i){
	            h=i
	        }
	    }
	    return h;
	}

	function impact(year){
		url='http://api.crossref.org/journals/'+issn+'/works?rows=1000&filter=from-pub-date:'+year+',until-pub-date:'+year
		//console.log(url)
		$.ajax({
		  	url: url,
		  	method: 'GET'
		}).then(function(data) {
			total_documents=data['message']['total-results']
			console.log(total_documents)

			//total_articles_3years+=total_articles
			items=data['message']['items'];
			citable_documents=0;
			cites[year]=[]
			items.forEach(function(item) {
				doi=item['DOI'];
				if ('author' in item){citable_documents++;	}
				cite=item['is-referenced-by-count'];
				cites[year].push(cite)
				dic[doi]=cite
				title[doi]=item['title']
				year[doi]=item['title']
				if ('published-print' in item){
					year_dic[doi]=item['published-print']['date-parts'][0][0]
				}
				if ('published-online' in item){
					year_dic[doi]=item['published-online']['date-parts'][0][0]
				}
			});
			citable_documents_3years+=citable_documents
			cites_3years=cites_3years.concat(cites[year])
			total_citations=cites[year].reduce(function(sum, value) {return sum + value}, 0);

			if (citable_documents>0){
			impact=total_citations/citable_documents;
			}else impact=0;
			document.getElementById(year+'_articles').innerHTML = citable_documents		
			document.getElementById(year+'_citations').innerHTML = total_citations;
			document.getElementById(year+'_impact').innerHTML = impact.toFixed(2);	

			total_citations_3years=cites_3years.reduce(function(a, b){ return a + b;},0);
			if (citable_documents_3years){
			impact_3years=total_citations_3years/citable_documents_3years;
			}else impact_3years=0;
			
			document.getElementById('citable_articles').innerHTML = citable_documents_3years;
			document.getElementById('total_citations').innerHTML = total_citations_3years;
			document.getElementById('total_impact').innerHTML = impact_3years.toFixed(2);	
		});
		
	}

	$(document).ready(function () {
		issn=window.location.search.replace('?issn=','');
		years=['2014']//,'2015','2016'];
		citable_documents_3years=0
		cites_3years=[]
		dic={}
		cites={}
		title={}
		year_dic={}


		years.forEach(function(year){
			impact(year)
		});

		$(document).ajaxStop(function () {
			h=h_index(cites_3years)
		    years.forEach(function(year){
				document.getElementById('total_h').innerHTML = h;	
			});
			sorted_dois = Object.keys(dic).sort(function(a,b){return dic[b]-dic[a]}).slice(0, h);
			sorted_dois.forEach(function(sorted_doi){
				document.getElementById('top').innerHTML += '<tr><td><a href=https://doi.org/'+sorted_doi+' target="_blank">' +title[sorted_doi]+'</td><td>'+year_dic[sorted_doi]+'</td><td>'+dic[sorted_doi]+'</td></tr>'
			});

		$(".loader").hide();
		});
	});
</script>
</html>