<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Scholarly Journals Database</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel = "stylesheet" type = "text/css" href = "css/style.css">

	</head>
	<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="sjdb.html">Home</a></li>
            <li><a href="mailto:moqri@ufl.edu">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">	
		<br><br><br>
		<h3 id=title></h3>
		<p id=publisher>Publisher: </p>
		<p id=issn> ISSN: </p>
		<p id=subject> Subject: </p>
		<br>
		<h4>Impact</h4>
		<table class="table" id="data-table">
		    <thead>
		        <tr>
		            <th>Year</th>
		            <th>Citable Documents</th>
		            <th>Citations</th>
		            <th>Impact (Citations/Articles)</th>
		            <th>h3 Index</th>
		        </tr>	        
		    </thead>
		    <tbody>
		        <tr>
					<td>2014</td>
					<td id='4_articles'></td>
					<td id='4_citations'></td>
					<td id='4_impact'></td>
		        </tr>
		        <tr>
					<td>2015</td>
					<td id='5_articles'></td>
					<td id='5_citations'></td>
					<td id='5_impact'></td>
		        </tr>
		        <tr>
		        	<td>2016</td>
					<td id='6_articles'></td>
					<td id='6_citations'></td>
					<td id='6_impact'></td>
		        </tr>
		        <tr>
		        	<td>3-year</td>
					<td><b><p id='citable_articles'></p></b></td>
					<td><b><P id='total_citations'></p></b></td>
					<td><b><p id='total_impact'></p></b></td>
					<td><b><p id='total_h'></p></b></td>
		        </tr>
		    </tbody>
		</table>
		<br>
		<h4>Top Articles</h4>
		<table class="table" id='top'>
			<thead>
				<th>Article</th>
				<th>Year</th>
				<th>Citations</th>
			</thead>
		</table>
		<div class="loader"></div>
		<button id="load_more" class="btn btn-link" type="submit" onclick="list_documents();">Load more (click and wait)</button>

		<footer>
		  <br>
		  <p>Data Source: <a href="https://www.crossref.org/" target="_blank"> Crossref</a></p>
		</footer>
	</div>
</body>
<script>
	function getParameterByName(name, url) {
	    if (!url) url = window.location.href;
	    name = name.replace(/[\[\]]/g, "\\$&");
	    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
	        results = regex.exec(url);
	    if (!results) return null;
	    if (!results[2]) return '';
	    return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
	function h_index(cites_3years){
		var h=0
		cites_3years.sort(function (a, b) {  return b - a;  });
    	for (i=1; i <= cites_3years.length; i++){
            if (cites_3years[i-1] >= i){
	            h=i
	        }
	    }
	    return h;
	}

	function get_journal(issn){
		base='http://brdb.warrington.ufl.edu:3030/test14/'
		s='<'+base+issn+'>'
		endpoint=base+'query'
		limit='limit 1000';
		var query = [
		 "PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>",
		 "select DISTINCT ?s ?title ",
		 "?docs_4 ?citation_4 (xsd:decimal(?impact_float_4) AS ?impact_4) ",
		 "?docs_5 ?citation_5 (xsd:decimal(?impact_float_5) AS ?impact_5) ",
		 "?docs_6 ?citation_6 (xsd:decimal(?impact_float_6) AS ?impact_6) ",
		 "?docs   ?citation   (xsd:decimal(?impact_float) AS ?impact) ",
		 "?h ?publisher (group_concat(?subjects;separator=' - ') as ?subject)",
		 "WHERE {",
			s,
			" <e:title> ?title;",
			"<e:subjects> ?subjects;",
			"<e:publisher> ?publisher;",
			"<e:count_4> ?docs_4; <e:citation_4> ?citation_4; <e:impact_4> ?impact_float_4;",
			"<e:count_5> ?docs_5; <e:citation_5> ?citation_5; <e:impact_5> ?impact_float_5;",
			"<e:count_6> ?docs_6; <e:citation_6> ?citation_6; <e:impact_6> ?impact_float_6;",
			"<e:count> ?docs;",
			"<e:citation> ?citation;",
			"<e:impact> ?impact_float;",
			"<e:h> ?h;",
		 "}",
		 "group by ?s ?title ?publisher",
		 "?docs_4 ?citation_4 ?impact_float_4 ",
		 "?docs_5 ?citation_5 ?impact_float_5 ",
		 "?docs_6 ?citation_6 ?impact_float_6 ",
		 "?docs ?citation ?impact_float ?h ",
		 "ORDER BY DESC(?h)",
		 limit 
		].join(" ");	
		url=endpoint+'?query='+encodeURIComponent(query) +"&format=json";
			return $.ajax({
				url: url,
				method: 'GET'
			}).then(function(data) {
				journal=data['results']['bindings'][0];
				title=journal['title']['value'];
				subject=journal['subject']['value'];
				console.log(url)
				console.log(journal)
				//console.log(subjects)
				//publisher=journal['publisher']['value'];
				count_documents['total']=parseInt(journal['docs']['value']);		
				count_citation['total']=parseInt(journal['citation']['value']);		
				impact['total']=journal['impact']['value'];		
				h=journal['h']['value'];

				for (var year = 4; year < 7; year++) {
					year=year.toString()
					count_documents[year]=parseInt(journal['docs_'+year]['value']);
					count_citation[year]=parseInt(journal['citation_'+year]['value']);
					impact[year]=journal['impact_'+year]['value'];
					document.getElementById(year+'_articles').innerHTML = count_documents[year].toLocaleString()
					document.getElementById(year+'_citations').innerHTML = count_citation[year].toLocaleString()
					document.getElementById(year+'_impact').innerHTML = impact[year]
				}
				document.getElementById('citable_articles').innerHTML = count_documents['total'].toLocaleString();
				document.getElementById('total_citations').innerHTML = count_citation['total'].toLocaleString()
				document.getElementById('total_impact').innerHTML = impact['total']		
				document.getElementById('total_h').innerHTML = h;
				document.getElementById('subject').innerHTML += subject


			});
		};

	function list_documents(){
		url='http://api.crossref.org/journals/'+issn+'/works?rows=20&filter=from-pub-date:2014,until-pub-date:2016&sort=is-referenced-by-count'+'&offset='+offset.toString()
		$.ajax({
		  	url: url,
		  	method: 'GET',
		  	success: function(data) {
				items=data['message']['items'];
				items.forEach(function(item) {
					doi=item['DOI'];
					cite=item['is-referenced-by-count'];
					yearp=yearo=9999
					if ('published-print' in item){
						yearp=item['published-print']['date-parts'][0][0]
					}
					if ('published-online' in item){
						yearo=item['published-online']['date-parts'][0][0]
					}
					year=Math.min(yearp,yearo)
					title=item['title']
					document.getElementById('top').innerHTML += '<tr><td><a href=https://doi.org/'+doi+' target="_blank">' +title+'</td><td>'+year+'</td><td>'+cite+'</td></tr>'
				});
			offset+=20
			}
		});
	}
	$(document).ready(function () {
		issn=getParameterByName('issn');document.getElementById('issn').innerHTML += issn	
		title=getParameterByName('title');document.getElementById('title').innerHTML = title	
		publisher=getParameterByName('publisher');document.getElementById('publisher').innerHTML += publisher	

		count_documents={}
		count_citation={}
		impact={}
		offset=0
		list_documents()
		get_journal(issn)

		$(document).ajaxStop(function () {
		$(".loader").hide();
		});
	});
</script>
</html>