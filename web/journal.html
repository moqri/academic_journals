<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Scholarly Journals Database</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel = "stylesheet" type = "text/css" href = "css/style.css">

	</head>
	<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">	
	<br></br>
	<h3>Impact</h3>
	<table class="table" id="data-table">
	    <thead>
	        <tr>
	            <th>Year</th>
	            <th>Citable Documents</th>
	            <th>Citations</th>
	            <th>Impact (Articles/Citations)</th>
	            <th>h-index</th>
	        </tr>	        
	    </thead>
	    <tbody>
	        <tr>
				<td>2014</td>
				<td id='4_articles'></td>
				<td id='4_citations'></td>
				<td id='4_impact'></td>
	        </tr>
	        <tr>
				<td>2015</td>
				<td id='5_articles'></td>
				<td id='5_citations'></td>
				<td id='5_impact'></td>
	        </tr>
	        <tr>
	        	<td>2016</td>
				<td id='6_articles'></td>
				<td id='6_citations'></td>
				<td id='6_impact'></td>
	        </tr>
	        <tr>
	        	<td>3-year</td>
				<td id='citable_articles'></td>
				<td id='total_citations'></td>
				<td id='total_impact'></td>
				<td id='total_h'></td>
	        </tr>
	    </tbody>
	</table>
	<h3>h-indexed Articles</h3>
	<table class="table" id='top'>
		<thead>
			<th>Article</th>
			<th>Year</th>
			<th>Citations</th>
		</thead>
	</table>
	<div class="loader"></div>
	</div>
</body>
<script>
	function getParameterByName(name, url) {
	    if (!url) url = window.location.href;
	    name = name.replace(/[\[\]]/g, "\\$&");
	    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
	        results = regex.exec(url);
	    if (!results) return null;
	    if (!results[2]) return '';
	    return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
	function h_index(cites_3years){
		var h=0
		cites_3years.sort(function (a, b) {  return b - a;  });
    	for (i=1; i <= cites_3years.length; i++){
            if (cites_3years[i-1] >= i){
	            h=i
	        }
	    }
	    return h;
	}

	function get_journal(issn){
		base='http://brdb.warrington.ufl.edu:3030/test11/'
		s='<'+base+issn+'>'
		endpoint=base+'query'
		limit='limit 100';
		var query = [
		 "PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>",
		 "select DISTINCT ?s ?title ",
		 "?docs_4 ?citation_4 (xsd:decimal(?impact_float_4) AS ?impact_4) ",
		 "?docs_5 ?citation_5 (xsd:decimal(?impact_float_5) AS ?impact_5) ",
		 "?docs_6 ?citation_6 (xsd:decimal(?impact_float_6) AS ?impact_6) ",
		 "?docs   ?citation   (xsd:decimal(?impact_float) AS ?impact) ",
		 "?h (group_concat(?publisher) as ?publishers)",
		 "WHERE {",
			s,
			" <e:title> ?title;",
			"<e:publisher> ?publisher;",
			"<e:count_4> ?docs_4; <e:citation_4> ?citation_4; <e:impact_4> ?impact_float_4;",
			"<e:count_5> ?docs_5; <e:citation_5> ?citation_5; <e:impact_5> ?impact_float_5;",
			"<e:count_6> ?docs_6; <e:citation_6> ?citation_6; <e:impact_6> ?impact_float_6;",
			"<e:count> ?docs;",
			"<e:citation> ?citation;",
			"<e:impact> ?impact_float;",
			"<e:h> ?h;",
		 "}",
		 "group by ?s ?title ",
		 "?docs_4 ?citation_4 ?impact_float_4 ",
		 "?docs_5 ?citation_5 ?impact_float_5 ",
		 "?docs_6 ?citation_6 ?impact_float_6 ",
		 "?docs ?citation ?impact_float ?h ",
		 "ORDER BY DESC(?h)",
		 limit
		].join(" ");	
		url=endpoint+'?query='+encodeURIComponent(query) +"&format=json";
		console.log(url)
			return $.ajax({
				url: url,
				method: 'GET'
			}).then(function(data) {
				journal=data['results']['bindings'][0];
				console.log(document.getElementById('journals_table'))			
				console.log(journal)
				title=journal['title']['value'];
				publisher=journal['publishers']['value'];
				count_documents['total']=journal['docs']['value'];		
				count_citation['total']=journal['citation']['value'];		
				impact['total']=journal['impact']['value'];		
				h=journal['h']['value'];

				for (var year = 4; year < 7; year++) {
					year=year.toString()
					count_documents[year]=journal['docs_'+year]['value'];
					count_citation[year]=journal['citation_'+year]['value'];
					impact[year]=journal['impact_'+year]['value'];
					document.getElementById(year+'_articles').innerHTML = count_documents[year]
					document.getElementById(year+'_citations').innerHTML = count_citation[year]
					document.getElementById(year+'_impact').innerHTML = impact[year]
				}
				document.getElementById('citable_articles').innerHTML = count_documents['total'];
				document.getElementById('total_citations').innerHTML = count_citation['total']
				document.getElementById('total_impact').innerHTML = impact['total']		
				document.getElementById('total_h').innerHTML = h;
			$(".loader").hide();
			});
		};

	function cross(cursor){
		url='http://api.crossref.org/journals/'+issn+'/works?rows=1000&filter=from-pub-date:2014,until-pub-date:2016&cursor='+encodeURIComponent(cursor)
		//console.log(url)
		$.ajax({
		  	url: url,
		  	method: 'GET',
		  	success: function(data) {
				items=data['message']['items'];
				items.forEach(function(item) {
					doi=item['DOI'];
					cite=item['is-referenced-by-count'];
					yearp=yearo=9999
					if ('published-print' in item){
						yearp=item['published-print']['date-parts'][0][0]
					}
					if ('published-online' in item){
						yearo=item['published-online']['date-parts'][0][0]
					}
					year=Math.min(yearp,yearo)
					year_dic[doi]=year
					cites[year].push(cite)
					//if ('author' in item | 1){citable_documents[year]++;	}
					dic[doi]=cite
					title[doi]=item['title']
				});
				total_documents_3years=0
				cites_3years=[]
				for (var year = 2014; year < 2017; year++) {
					console.log(year)
					if (cites[year].length>0){
					total_documents[year]=cites[year].length

						total_documents_3years+=total_documents[year]
						cites_3years=cites_3years.concat(cites[year])
						total_citations=cites[year].reduce(function(sum, value) {return sum + value}, 0);

						if (total_documents[year]>0){
						impact=total_citations/total_documents[year];
						}else impact=0;
						document.getElementById(year+'_articles').innerHTML = total_documents[year]	
						document.getElementById(year+'_citations').innerHTML = total_citations;
						document.getElementById(year+'_impact').innerHTML = impact.toFixed(2);	

						total_citations_3years=cites_3years.reduce(function(a, b){ return a + b;},0);
						if (total_documents_3years){
						impact_3years=total_citations_3years/total_documents_3years;
						}else impact_3years=0;
						
						document.getElementById('citable_articles').innerHTML = total_documents_3years;
						document.getElementById('total_citations').innerHTML = total_citations_3years;
						document.getElementById('total_impact').innerHTML = impact_3years.toFixed(2);
					}
				}	
				next_cursor=data['message']['next-cursor']
				if (next_cursor!=cursor){
					return cross(next_cursor)
				}
			}
		});
	}
	$(document).ready(function () {
		issn=getParameterByName('issn');
		docs=parseInt(getParameterByName('documents'));
		//years=['2014','2015','2016'];
		total_documents_3years=0
		cites_3years=[]
		dic={}
		count_documents={}
		count_citation={}
		impact={}
		cites={};cites[2014]=[];cites[2015]=[];cites[2016]=[]
		total_documents={2014:0,2015:0,2016:0}
		title={}
		year_dic={}


		//years.forEach(function(year){
		docs=1000
		years=['2014']
		cursor='*'
		//cursor=cross(cursor)
		get_journal(issn)

		$(document).ajaxStop(function () {
			sorted_dois = Object.keys(dic).sort(function(a,b){return dic[b]-dic[a]}).slice(0, h);
			sorted_dois.forEach(function(sorted_doi){
				document.getElementById('top').innerHTML += '<tr><td><a href=https://doi.org/'+sorted_doi+' target="_blank">' +title[sorted_doi]+'</td><td>'+year_dic[sorted_doi]+'</td><td>'+dic[sorted_doi]+'</td></tr>'
			});

		$(".loader").hide();
		});
	});
</script>
</html>